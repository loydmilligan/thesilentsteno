<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover, touch-action=pan-y">
    <title>Silent Steno - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Modern touch scrolling for Raspberry Pi */
        .touch-scroll-container {
            overflow-y: auto;
            scroll-behavior: smooth;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: auto;
            touch-action: pan-y pinch-zoom;
            height: 100%;
            max-height: 100%;
            /* Force hardware acceleration on Pi */
            transform: translateZ(0);
            will-change: scroll-position;
        }
        
        /* Ensure scrollable content extends beyond viewport */
        .scrollable-content {
            min-height: calc(100% + 1px);
            padding-bottom: 20px;
        }
        
        /* Hide scrollbar on touch devices but keep functionality */
        @media (pointer: coarse) {
            .touch-scroll-container::-webkit-scrollbar {
                width: 0;
                background: transparent;
            }
            .touch-scroll-container {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
        }
        
        /* Raspberry Pi specific optimizations */
        @media screen and (max-device-width: 1024px) {
            .touch-scroll-container {
                transform: translate3d(0, 0, 0);
                -webkit-transform: translate3d(0, 0, 0);
            }
        }
        
        /* Show thin scrollbar on desktop */
        @media (pointer: fine) {
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #1e293b;
            }
            ::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }
        }

        /* Large chunky UI elements for touch */
        .chunky-toggle {
            width: 80px;
            height: 48px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        
        .chunky-toggle input {
            display: none;
        }
        
        .chunky-toggle .toggle-slider {
            width: 100%;
            height: 100%;
            background: #475569;
            border-radius: 24px;
            position: relative;
            transition: background 0.3s;
            display: flex;
            align-items: center;
        }
        
        .chunky-toggle .toggle-knob {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            position: absolute;
            left: 4px;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .chunky-toggle input:checked + .toggle-slider {
            background: #3b82f6;
        }
        
        .chunky-toggle input:checked + .toggle-slider .toggle-knob {
            left: 36px;
        }

        /* Chunky dropdown styling */
        .chunky-select {
            height: 60px;
            font-size: 18px;
            font-weight: 600;
            touch-action: manipulation;
        }
        
        /* Chunky input styling */
        .chunky-input {
            height: 60px;
            font-size: 18px;
            touch-action: manipulation;
        }
        
        /* Chunky slider styling */
        .chunky-slider {
            height: 12px;
            -webkit-appearance: none;
            background: #475569;
            border-radius: 6px;
            outline: none;
            touch-action: manipulation;
        }
        
        .chunky-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        
        .chunky-slider::-moz-range-thumb {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        /* Setting section headers */
        .settings-section {
            margin-bottom: 32px;
        }
        
        .settings-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            border: 2px solid #475569;
        }

        /* Setting rows */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 20px;
            background: #1e293b;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #374151;
            touch-action: manipulation;
        }
        
        .setting-row:hover {
            background: #374151;
        }

        /* Message animations */
        @keyframes slideIn {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body class="h-screen antialiased text-white bg-slate-900">
    <div class="h-screen w-full flex flex-col">
        
        <!-- Header with Navigation -->
        <div class="flex justify-between items-center py-4 px-6 bg-slate-800 border-b border-slate-700">
            <div class="flex items-center gap-4">
                <button onclick="goBack()" class="p-3 rounded-full hover:bg-slate-700 transition-colors" title="Go back">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </button>
                <button onclick="reloadApp()" class="p-3 rounded-full hover:bg-slate-700 transition-colors" title="Reload App (Debug)">
                    <svg class="w-8 h-8 text-slate-300 hover:text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,12H10V10H14M14,16H10V14H14M20,8H17.19C16.74,7.22 16.12,6.55 15.37,6.04L17,4.41L15.59,3L13.42,5.17C12.96,5.06 12.5,5 12,5C11.5,5 11.04,5.06 10.59,5.17L8.41,3L7,4.41L8.62,6.04C7.88,6.55 7.26,7.22 6.81,8H4V10H6.09C6.04,10.33 6,10.66 6,11V12H4V14H6V15C6,15.34 6.04,15.67 6.09,16H4V18H6.81C7.85,19.79 9.78,21 12,21C14.22,21 16.15,19.79 17.19,18H20V16H17.91C17.96,15.67 18,15.34 18,15V14H20V12H18V11C18,10.66 17.96,10.33 17.91,10H20V8Z"/>
                    </svg>
                </button>
                <h1 class="text-3xl font-bold text-white">Settings</h1>
                <!-- Status indicator (recording timer if active) -->
                <div id="header-recording-timer" class="hidden bg-red-600 hover:bg-red-700 text-white font-mono font-bold py-2 px-4 rounded-lg text-sm cursor-pointer transition-colors" onclick="stopRecordingFromHeader()" title="Click to stop recording">
                    REC: <span id="header-timer-display">00:00:00</span>
                    <svg class="inline-block w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18,18H6V6H18V18Z"/>
                    </svg>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="goToControlsView()" class="bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200">
                    Live
                </button>
                <button onclick="window.location.href='/'" class="bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200">
                    Sessions
                </button>
                <button onclick="window.location.href='/dashboard'" class="bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200">
                    Dashboard
                </button>
                <div id="status-indicator" class="w-6 h-6 text-green-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg>
                </div>
            </div>
        </div>
        
        <!-- Settings Content -->
        <div class="flex-1 p-6 max-w-5xl mx-auto w-full touch-scroll-container">
            
            <!-- Audio & Recording Settings -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <svg class="w-8 h-8 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M12,4A1,1 0 0,0 11,5V11A1,1 0 0,0 12,12A1,1 0 0,0 13,11V5A1,1 0 0,0 12,4M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                    </svg>
                    <h2 class="text-2xl font-bold">Audio & Recording</h2>
                </div>
                
                <!-- Microphone Source -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Microphone Source</label>
                        <p class="text-slate-400 text-sm mt-1">Select audio input device</p>
                    </div>
                    <select id="microphone-source" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="default">Default Microphone</option>
                        <option value="usb">USB Microphone</option>
                        <option value="bluetooth">Bluetooth Headset</option>
                        <option value="built-in">Built-in Microphone</option>
                    </select>
                </div>
                
                <!-- Input Gain -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Input Gain</label>
                        <p class="text-slate-400 text-sm mt-1">Microphone recording volume</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-slate-400 text-sm">Low</span>
                        <input type="range" id="input-gain" class="chunky-slider w-32" min="0" max="1" step="0.1" value="0.5">
                        <span class="text-slate-400 text-sm">High</span>
                        <span id="gain-value" class="text-white font-mono text-lg min-w-12">50%</span>
                    </div>
                </div>
                
                <!-- Noise Suppression -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Noise Suppression</label>
                        <p class="text-slate-400 text-sm mt-1">Reduce background noise</p>
                    </div>
                    <select id="noise-suppression" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="off">Off</option>
                        <option value="low" selected>Low</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <!-- Voice Activity Detection -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Voice Activity Detection</label>
                        <p class="text-slate-400 text-sm mt-1">Auto-pause during silence</p>
                    </div>
                    <label class="chunky-toggle">
                        <input type="checkbox" id="voice-activity-detection" checked>
                        <div class="toggle-slider">
                            <div class="toggle-knob"></div>
                        </div>
                    </label>
                </div>
                
                <!-- Recording Format -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Recording Format</label>
                        <p class="text-slate-400 text-sm mt-1">Audio quality and format</p>
                    </div>
                    <select id="recording-format" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="wav" selected>WAV - High Quality</option>
                        <option value="mp3">MP3 - Compressed</option>
                    </select>
                </div>
            </div>
            
            <!-- Audio System Settings -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <svg class="w-8 h-8 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                    <h2 class="text-2xl font-bold">Audio System</h2>
                </div>
                
                <!-- Audio System Info -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Audio Engine</label>
                        <p class="text-slate-400 text-sm mt-1">Current audio system in use</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="audio-system-type" class="text-white font-medium">Detecting...</span>
                        <div id="audio-system-status" class="w-3 h-3 bg-gray-500 rounded-full"></div>
                    </div>
                </div>
                
                <!-- Target Latency -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Target Latency</label>
                        <p class="text-slate-400 text-sm mt-1">Lower latency = better responsiveness</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="range" id="target-latency" min="10" max="100" value="40" 
                               class="w-32 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider">
                        <span id="latency-value" class="text-white font-medium min-w-[50px]">40ms</span>
                    </div>
                </div>
                
                <!-- Current Latency Display -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Current Latency</label>
                        <p class="text-slate-400 text-sm mt-1">Measured audio delay</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="current-latency" class="text-white font-medium">--ms</span>
                        <button onclick="measureLatency()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm">
                            Measure
                        </button>
                    </div>
                </div>
                
                <!-- Advanced Audio Settings (collapsible) -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Advanced Settings</label>
                        <p class="text-slate-400 text-sm mt-1">Expert audio configuration</p>
                    </div>
                    <button onclick="toggleAdvancedAudio()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded">
                        <span id="advanced-audio-toggle">Show</span>
                    </button>
                </div>
                
                <!-- Advanced Settings Panel (hidden by default) -->
                <div id="advanced-audio-panel" class="hidden mt-4 p-4 bg-slate-800 rounded-lg space-y-4">
                    <!-- Sample Rate -->
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="text-white font-medium">Sample Rate</label>
                            <p class="text-slate-400 text-sm">Audio sampling frequency</p>
                        </div>
                        <select id="sample-rate" class="bg-slate-700 text-white border border-slate-600 rounded px-3 py-1">
                            <option value="44100" selected>44.1 kHz</option>
                            <option value="48000">48 kHz</option>
                        </select>
                    </div>
                    
                    <!-- Buffer Size -->
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="text-white font-medium">Buffer Size</label>
                            <p class="text-slate-400 text-sm">Audio buffer size in frames</p>
                        </div>
                        <select id="buffer-size" class="bg-slate-700 text-white border border-slate-600 rounded px-3 py-1">
                            <option value="64">64 frames</option>
                            <option value="128">128 frames</option>
                            <option value="256">256 frames</option>
                            <option value="512" selected>512 frames</option>
                            <option value="1024">1024 frames</option>
                        </select>
                    </div>
                    
                    <!-- Bluetooth Codec Preference -->
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="text-white font-medium">Preferred Bluetooth Codec</label>
                            <p class="text-slate-400 text-sm">Higher quality codecs when available</p>
                        </div>
                        <select id="bluetooth-codec" class="bg-slate-700 text-white border border-slate-600 rounded px-3 py-1">
                            <option value="auto" selected>Auto (Best Available)</option>
                            <option value="aac">AAC</option>
                            <option value="aptx">aptX</option>
                            <option value="sbc">SBC</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Bluetooth Devices Settings -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <svg class="w-8 h-8 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14.88,16.29L13,18.17V14.41M13,5.83L14.88,7.71L13,9.58M17.71,7.71L12,2H11V9.58L6.41,5L5,6.41L10.59,12L5,17.58L6.41,19L11,14.41V22H12L17.71,16.29L13.41,12L17.71,7.71Z"/>
                    </svg>
                    <h2 class="text-2xl font-bold">Bluetooth Devices</h2>
                </div>
                
                <!-- Bluetooth Devices Container -->
                <div id="bluetooth-devices-container">
                    <!-- Audio Sources Section -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17,2A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2H17M12,4A1,1 0 0,0 11,5A1,1 0 0,0 12,6A1,1 0 0,0 13,5A1,1 0 0,0 12,4M12,18A1,1 0 0,0 11,19A1,1 0 0,0 12,20A1,1 0 0,0 13,19A1,1 0 0,0 12,18Z"/>
                            </svg>
                            Audio Sources
                            <span class="text-sm text-slate-400">(Phones, Tablets, Laptops)</span>
                        </h3>
                        <div id="bluetooth-sources-list" class="space-y-3">
                            <!-- Loading indicator -->
                            <div class="text-center py-4">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"></div>
                                <p class="text-slate-400 mt-2">Loading devices...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audio Outputs Section -->
                    <div>
                        <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                            <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,1L8,5H4A2,2 0 0,0 2,7V17A2,2 0 0,0 4,19H8L12,23A1,1 0 0,0 13,22V2A1,1 0 0,0 12,1M7.5,15H4V9H7.5L10,6.5V17.5M16.5,12A4.5,4.5 0 0,0 14,7.97V16.03A4.5,4.5 0 0,0 16.5,12M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23Z"/>
                            </svg>
                            Audio Outputs
                            <span class="text-sm text-slate-400">(Headphones, Speakers)</span>
                        </h3>
                        <div id="bluetooth-outputs-list" class="space-y-3">
                            <!-- Loading indicator -->
                            <div class="text-center py-4">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-400"></div>
                                <p class="text-slate-400 mt-2">Loading devices...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-6 pt-6 border-t border-slate-700">
                        <div class="flex flex-wrap gap-4">
                            <button onclick="refreshBluetoothDevices()" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/>
                                </svg>
                                Refresh
                            </button>
                            <button onclick="enableAudioForwarding()" id="enable-forwarding-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center gap-2 hidden">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                                </svg>
                                Enable Audio Forwarding
                            </button>
                            <button onclick="stopAudioForwarding()" id="stop-forwarding-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center gap-2 hidden">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18,18H6V6H18V18Z"/>
                                </svg>
                                Stop Forwarding
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transcription & AI Settings -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17,7H22V17H17V19A1,1 0 0,0 18,20H20V22H17.5C16.95,22 16,21.55 16,21C16,21.55 15.05,22 14.5,22H12V20H14A1,1 0 0,0 15,19V5A1,1 0 0,0 14,4H12V2H14.5C15.05,2 16,2.45 16,3C16,2.45 16.95,2 17.5,2H20V4H18A1,1 0 0,0 17,5V7M2,7H13V9H4V15H13V17H2V7M20,15V9H17V15H20Z"/>
                    </svg>
                    <h2 class="text-2xl font-bold">Transcription & AI</h2>
                </div>
                
                <!-- Transcription Language -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Transcription Language</label>
                        <p class="text-slate-400 text-sm mt-1">Primary spoken language</p>
                    </div>
                    <select id="transcription-language" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="en" selected>English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                    </select>
                </div>
                
                <!-- Whisper Model -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Whisper Model</label>
                        <p class="text-slate-400 text-sm mt-1">Balance speed vs accuracy</p>
                    </div>
                    <select id="whisper-model" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="base" selected>Base - Fast</option>
                        <option value="small">Small - Balanced</option>
                        <option value="medium">Medium - Accurate</option>
                        <option value="large">Large - Most Accurate</option>
                    </select>
                </div>
                
                <!-- Custom Vocabulary -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Custom Vocabulary</label>
                        <p class="text-slate-400 text-sm mt-1">Comma-separated terms, acronyms</p>
                    </div>
                    <input type="text" id="custom-vocabulary" class="chunky-input bg-slate-700 text-white border border-slate-600 rounded-lg px-4 w-80" placeholder="API, ML, DevOps, ...">
                </div>
                
                <!-- Automatic Punctuation -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Automatic Punctuation</label>
                        <p class="text-slate-400 text-sm mt-1">AI-driven punctuation</p>
                    </div>
                    <label class="chunky-toggle">
                        <input type="checkbox" id="automatic-punctuation" checked>
                        <div class="toggle-slider">
                            <div class="toggle-knob"></div>
                        </div>
                    </label>
                </div>
                
                <!-- Post-Meeting Summaries -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Post-Meeting Summaries</label>
                        <p class="text-slate-400 text-sm mt-1">Auto-generate after recording</p>
                    </div>
                    <label class="chunky-toggle">
                        <input type="checkbox" id="post-meeting-summaries" checked>
                        <div class="toggle-slider">
                            <div class="toggle-knob"></div>
                        </div>
                    </label>
                </div>
                
                <!-- Gemini AI Enhancement -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Gemini AI Enhancement</label>
                        <p class="text-slate-400 text-sm mt-1">Advanced analysis and summaries</p>
                    </div>
                    <label class="chunky-toggle">
                        <input type="checkbox" id="use-gemini-enhancement">
                        <div class="toggle-slider">
                            <div class="toggle-knob"></div>
                        </div>
                    </label>
                </div>
                
                <!-- Gemini API Key -->
                <div class="setting-row" id="gemini-api-key-row" style="display: none;">
                    <div>
                        <label class="text-xl font-semibold text-white block">Gemini API Key</label>
                        <p class="text-slate-400 text-sm mt-1">Required for AI enhancement features</p>
                    </div>
                    <input type="password" id="gemini-api-key" class="chunky-input bg-slate-700 text-white border border-slate-600 rounded-lg px-4 w-80" placeholder="Enter your Gemini API key">
                </div>
            </div>
            
            <!-- Interface Settings -->
            <div class="settings-section">
                <div class="settings-section-header">
                    <svg class="w-8 h-8 text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7.27C13.6,7.61 14,8.26 14,9A2,2 0 0,1 12,11A2,2 0 0,1 10,9A2,2 0 0,1 12,7A2,2 0 0,1 14,9A2,2 0 0,1 12,11A2,2 0 0,1 10,9C10,8.26 10.4,7.61 11,7.27V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M12,15A2,2 0 0,1 14,17A2,2 0 0,1 12,19A2,2 0 0,1 10,17A2,2 0 0,1 12,15M12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17A2,2 0 0,1 10,15A2,2 0 0,1 12,13Z"/>
                    </svg>
                    <h2 class="text-2xl font-bold">Interface</h2>
                </div>
                
                <!-- Theme -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Theme</label>
                        <p class="text-slate-400 text-sm mt-1">Display appearance</p>
                    </div>
                    <select id="theme" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="dark" selected>Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
                
                <!-- Font Size -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Font Size</label>
                        <p class="text-slate-400 text-sm mt-1">Text size in transcript viewer</p>
                    </div>
                    <select id="font-size" class="chunky-select bg-slate-700 text-white border border-slate-600 rounded-lg px-4">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
                
                <!-- Auto-scroll Transcript -->
                <div class="setting-row">
                    <div>
                        <label class="text-xl font-semibold text-white block">Auto-scroll Transcript</label>
                        <p class="text-slate-400 text-sm mt-1">Follow live transcription</p>
                    </div>
                    <label class="chunky-toggle">
                        <input type="checkbox" id="auto-scroll-transcript" checked>
                        <div class="toggle-slider">
                            <div class="toggle-knob"></div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-6 pt-8 pb-4">
                <button onclick="saveSettings()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-colors">
                    Save Settings
                </button>
                <button onclick="resetToDefaults()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-xl text-xl transition-colors">
                    Reset to Defaults
                </button>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time updates
        const socket = io();
        
        // Settings state
        let currentSettings = {};
        
        // Navigation functions
        function goBack() {
            window.history.back();
        }
        
        function goToControlsView() {
            window.location.href = '/?view=controls';
        }
        
        // Bluetooth device management
        let bluetoothDevices = { sources: [], outputs: [] };
        let connectedSource = null;
        let connectedOutput = null;
        
        async function loadBluetoothDevices() {
            try {
                const response = await fetch('/api/bluetooth/devices');
                if (response.ok) {
                    bluetoothDevices = await response.json();
                    renderBluetoothDevices();
                    updateForwardingButtons();
                } else {
                    console.error('Failed to load Bluetooth devices');
                    showMessage('Failed to load Bluetooth devices', 'error');
                }
            } catch (error) {
                console.error('Error loading Bluetooth devices:', error);
                showMessage('Error loading Bluetooth devices', 'error');
            }
        }
        
        function renderBluetoothDevices() {
            // Render sources
            const sourcesList = document.getElementById('bluetooth-sources-list');
            sourcesList.innerHTML = '';
            
            if (bluetoothDevices.sources.length === 0) {
                sourcesList.innerHTML = '<p class="text-slate-400 text-center py-4">No audio sources found</p>';
            } else {
                bluetoothDevices.sources.forEach(device => {
                    const deviceEl = createDeviceElement(device, 'source');
                    sourcesList.appendChild(deviceEl);
                    if (device.connected && device.active) {
                        connectedSource = device;
                    }
                });
            }
            
            // Render outputs
            const outputsList = document.getElementById('bluetooth-outputs-list');
            outputsList.innerHTML = '';
            
            if (bluetoothDevices.outputs.length === 0) {
                outputsList.innerHTML = '<p class="text-slate-400 text-center py-4">No audio outputs found</p>';
            } else {
                bluetoothDevices.outputs.forEach(device => {
                    const deviceEl = createDeviceElement(device, 'output');
                    outputsList.appendChild(deviceEl);
                    if (device.connected && device.active) {
                        connectedOutput = device;
                    }
                });
            }
        }
        
        function createDeviceElement(device, type) {
            const div = document.createElement('div');
            
            // Card-based selection styling - highlight if active
            const isActive = device.active;
            const baseClasses = 'rounded-lg p-4 border-2 transition-all duration-200 cursor-pointer';
            const activeClasses = isActive 
                ? 'bg-blue-900 border-blue-500 shadow-lg shadow-blue-500/20' 
                : 'bg-slate-800 border-slate-700 hover:border-slate-600';
            
            div.className = `${baseClasses} ${activeClasses}`;
            
            // Main content container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-center justify-between';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'flex items-center gap-3 flex-1';
            
            // Selection indicator + device icon
            const iconDiv = document.createElement('div');
            iconDiv.className = 'relative';
            
            // Device icon with status-based background
            const statusInfo = getDeviceStatusInfo(device);
            const deviceIcon = document.createElement('div');
            deviceIcon.className = `p-3 rounded-full ${statusInfo.bgClass}`;
            deviceIcon.innerHTML = getDeviceIcon(device.type || type);
            
            // Active selection checkmark
            if (isActive) {
                const checkmark = document.createElement('div');
                checkmark.className = 'absolute -top-1 -right-1 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold';
                checkmark.innerHTML = '✓';
                iconDiv.appendChild(checkmark);
            }
            
            iconDiv.appendChild(deviceIcon);
            
            // Device info
            const textDiv = document.createElement('div');
            textDiv.innerHTML = `
                <h4 class="text-lg font-semibold text-white flex items-center gap-2">
                    ${device.name}
                    ${isActive ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">ACTIVE</span>' : ''}
                </h4>
                <p class="text-sm text-slate-400">${device.mac === 'builtin' ? 'Built-in Audio' : device.mac}</p>
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-2xl">${statusInfo.indicator}</span>
                    <span class="${statusInfo.textClass}">${statusInfo.statusText}</span>
                </div>
            `;
            
            infoDiv.appendChild(iconDiv);
            infoDiv.appendChild(textDiv);
            
            // Button controls container
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'flex flex-col gap-2';
            
            // Select/Activate button (only for connected devices)
            if (device.connected && !isActive) {
                const selectButton = document.createElement('button');
                selectButton.className = 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2';
                selectButton.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                    </svg>
                    Select
                `;
                
                if (device.mac === 'builtin') {
                    selectButton.onclick = () => switchToBuiltinSpeakers(device);
                } else if (type === 'output') {
                    selectButton.onclick = () => switchToDevice(device, 'output');
                } else {
                    selectButton.onclick = () => switchToDevice(device, 'source');
                }
                
                buttonsDiv.appendChild(selectButton);
            }
            
            // Connect/Disconnect button
            const connectionButton = document.createElement('button');
            if (device.mac === 'builtin') {
                // Built-in devices can't be disconnected
                connectionButton.className = 'bg-slate-600 text-slate-400 font-semibold py-2 px-4 rounded-lg cursor-default';
                connectionButton.textContent = 'Built-in';
                connectionButton.disabled = true;
            } else {
                connectionButton.className = device.connected 
                    ? 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors'
                    : 'bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors';
                connectionButton.textContent = device.connected ? 'Disconnect' : 'Connect';
                connectionButton.onclick = () => device.connected ? disconnectDevice(device, type) : connectDevice(device, type);
            }
            
            buttonsDiv.appendChild(connectionButton);
            
            // Card click to select (for connected devices)
            if (device.connected && !isActive) {
                div.onclick = (e) => {
                    // Don't trigger if clicking on buttons
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                    
                    if (device.mac === 'builtin') {
                        switchToBuiltinSpeakers(device);
                    } else if (type === 'output') {
                        switchToDevice(device, 'output');
                    } else {
                        switchToDevice(device, 'source');
                    }
                };
            } else {
                div.style.cursor = 'default';
            }
            
            contentDiv.appendChild(infoDiv);
            contentDiv.appendChild(buttonsDiv);
            div.appendChild(contentDiv);
            
            return div;
        }
        
        function getDeviceIcon(deviceType) {
            switch(deviceType) {
                case 'phone':
                    return '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17,2A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2H17M12,4A1,1 0 0,0 11,5A1,1 0 0,0 12,6A1,1 0 0,0 13,5A1,1 0 0,0 12,4M12,18A1,1 0 0,0 11,19A1,1 0 0,0 12,20A1,1 0 0,0 13,19A1,1 0 0,0 12,18Z"/></svg>';
                case 'headphones':
                    return '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12,1C7,1 3,5 3,10V17A3,3 0 0,0 6,20H9V12H5V10A7,7 0 0,1 12,3A7,7 0 0,1 19,10V12H15V20H18A3,3 0 0,0 21,17V10C21,5 17,1 12,1Z"/></svg>';
                case 'speakers':
                    return '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.03C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>';
                case 'speaker':
                    return '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.03C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>';
                default:
                    return '<svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M14.88,16.29L13,18.17V14.41M13,5.83L14.88,7.71L13,9.58M17.71,7.71L12,2H11V9.58L6.41,5L5,6.41L10.59,12L5,17.58L6.41,19L11,14.41V22H12L17.71,16.29L13.41,12L17.71,7.71Z"/></svg>';
            }
        }
        
        function getDeviceStatusInfo(device) {
            // Three-state visual indicators based on PulseAudio status
            const status = device.status || 'not_available';
            
            switch(status) {
                case 'not_available':
                    return {
                        indicator: '🔴',
                        statusText: 'Not Connected',
                        textClass: 'text-red-400',
                        bgClass: 'bg-red-900'
                    };
                case 'idle':
                    return {
                        indicator: '🟡',
                        statusText: 'Ready',
                        textClass: 'text-yellow-400',
                        bgClass: 'bg-yellow-900'
                    };
                case 'running':
                    return {
                        indicator: '🟢',
                        statusText: 'Active',
                        textClass: 'text-green-400',
                        bgClass: 'bg-green-900'
                    };
                default:
                    // Fallback for old connected/active system
                    if (device.active) {
                        return {
                            indicator: '🟢',
                            statusText: 'Active',
                            textClass: 'text-green-400',
                            bgClass: 'bg-green-900'
                        };
                    } else if (device.connected) {
                        return {
                            indicator: '🟡',
                            statusText: 'Ready',
                            textClass: 'text-yellow-400',
                            bgClass: 'bg-yellow-900'
                        };
                    } else {
                        return {
                            indicator: '🔴',
                            statusText: 'Not Connected',
                            textClass: 'text-red-400',
                            bgClass: 'bg-red-900'
                        };
                    }
            }
        }
        
        async function connectDevice(device, type) {
            showMessage(`Connecting to ${device.name}...`, 'info');
            try {
                const response = await fetch('/api/bluetooth/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mac: device.mac, type: type })
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    await loadBluetoothDevices();
                } else {
                    showMessage(result.error || 'Failed to connect', 'error');
                }
            } catch (error) {
                showMessage('Error connecting to device', 'error');
                console.error('Connection error:', error);
            }
        }
        
        async function disconnectDevice(device, type) {
            showMessage(`Disconnecting from ${device.name}...`, 'info');
            try {
                const response = await fetch('/api/bluetooth/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mac: device.mac })
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    await loadBluetoothDevices();
                } else {
                    showMessage(result.error || 'Failed to disconnect', 'error');
                }
            } catch (error) {
                showMessage('Error disconnecting from device', 'error');
                console.error('Disconnection error:', error);
            }
        }
        
        async function switchToBuiltinSpeakers(device) {
            showMessage('Switching to built-in speakers...', 'info');
            try {
                const response = await fetch('/api/audio/switch_sink', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sink_name: device.pa_sink })
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage('Switched to built-in speakers', 'success');
                    await loadBluetoothDevices();
                } else {
                    showMessage(result.error || 'Failed to switch audio output', 'error');
                }
            } catch (error) {
                showMessage('Error switching audio output', 'error');
                console.error('Audio switch error:', error);
            }
        }
        
        async function switchToDevice(device, deviceType) {
            const deviceTypeText = deviceType === 'output' ? 'output' : 'source';
            showMessage(`Switching to ${device.name}...`, 'info');
            
            try {
                if (deviceType === 'output') {
                    // Switch audio output (sink)
                    const response = await fetch('/api/audio/switch_sink', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sink_name: device.pa_sink })
                    });
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showMessage(`Audio output switched to ${device.name}`, 'success');
                        await loadBluetoothDevices();
                    } else {
                        showMessage(result.error || 'Failed to switch audio output', 'error');
                    }
                } else {
                    // Switch audio input (source)
                    const response = await fetch('/api/audio/switch_source', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source_name: device.pa_source })
                    });
                    
                    const result = await response.json();
                    if (response.ok && result.success) {
                        showMessage(`Audio input switched to ${device.name}`, 'success');
                        await loadBluetoothDevices();
                    } else {
                        showMessage(result.error || 'Failed to switch audio input', 'error');
                    }
                }
            } catch (error) {
                showMessage(`Error switching to ${device.name}`, 'error');
                console.error('Device switch error:', error);
            }
        }
        
        function refreshBluetoothDevices() {
            showMessage('Refreshing Bluetooth devices...', 'info');
            loadBluetoothDevices();
        }
        
        function updateForwardingButtons() {
            const enableBtn = document.getElementById('enable-forwarding-btn');
            const stopBtn = document.getElementById('stop-forwarding-btn');
            
            // Check if forwarding is active (both source and output are active)
            const isForwardingActive = connectedSource && connectedOutput && 
                                     connectedSource.active && connectedOutput.active;
            
            if (isForwardingActive) {
                // Forwarding is active - show stop button, hide enable button
                enableBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            } else if (connectedSource && connectedOutput) {
                // Devices are connected but not actively forwarding - show enable button
                enableBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            } else {
                // Not enough devices connected - hide both buttons
                enableBtn.classList.add('hidden');
                stopBtn.classList.add('hidden');
            }
        }
        
        async function enableAudioForwarding() {
            if (!connectedSource || !connectedOutput) {
                showMessage('Please connect both an audio source and output first', 'warning');
                return;
            }
            
            showMessage('Enabling audio forwarding...', 'info');
            try {
                const response = await fetch('/api/bluetooth/connect_source', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage('Audio forwarding enabled', 'success');
                    await loadBluetoothDevices();
                } else {
                    showMessage(result.error || 'Failed to enable forwarding', 'error');
                }
            } catch (error) {
                showMessage('Error enabling audio forwarding', 'error');
                console.error('Forwarding error:', error);
            }
        }
        
        async function stopAudioForwarding() {
            showMessage('Stopping audio forwarding...', 'info');
            try {
                const response = await fetch('/api/bluetooth/stop_forwarding', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (response.ok && result.success) {
                    showMessage(result.message, 'success');
                    await loadBluetoothDevices();
                } else {
                    showMessage(result.error || 'Failed to stop forwarding', 'error');
                }
            } catch (error) {
                showMessage('Error stopping audio forwarding', 'error');
                console.error('Stop forwarding error:', error);
            }
        }
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupEventListeners();
            loadBluetoothDevices();
        });
        
        function setupEventListeners() {
            // Input gain slider
            const gainSlider = document.getElementById('input-gain');
            const gainValue = document.getElementById('gain-value');
            
            // Gemini enhancement toggle
            const geminiToggle = document.getElementById('use-gemini-enhancement');
            const geminiApiKeyRow = document.getElementById('gemini-api-key-row');
            
            function toggleGeminiApiKey() {
                if (geminiToggle.checked) {
                    geminiApiKeyRow.style.display = 'flex';
                } else {
                    geminiApiKeyRow.style.display = 'none';
                }
            }
            
            geminiToggle.addEventListener('change', toggleGeminiApiKey);
            // Set initial state
            toggleGeminiApiKey();
            
            gainSlider.addEventListener('input', function() {
                const value = Math.round(this.value * 100);
                gainValue.textContent = value + '%';
            });
        }
        
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                if (response.ok) {
                    currentSettings = await response.json();
                    populateSettingsForm(currentSettings);
                } else {
                    console.error('Failed to load settings');
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function populateSettingsForm(settings) {
            // Audio settings
            if (settings.audio) {
                document.getElementById('microphone-source').value = settings.audio.microphone_source || 'default';
                document.getElementById('input-gain').value = settings.audio.input_gain || 0.5;
                document.getElementById('gain-value').textContent = Math.round((settings.audio.input_gain || 0.5) * 100) + '%';
                document.getElementById('noise-suppression').value = settings.audio.noise_suppression || 'low';
                document.getElementById('voice-activity-detection').checked = settings.audio.voice_activity_detection !== false;
                document.getElementById('recording-format').value = settings.audio.recording_format || 'wav';
            }
            
            // Transcription settings
            if (settings.transcription) {
                document.getElementById('transcription-language').value = settings.transcription.transcription_language || 'en';
                document.getElementById('whisper-model').value = settings.transcription.whisper_model || 'base';
                document.getElementById('custom-vocabulary').value = settings.transcription.custom_vocabulary || '';
                document.getElementById('automatic-punctuation').checked = settings.transcription.automatic_punctuation !== false;
                document.getElementById('post-meeting-summaries').checked = settings.transcription.post_meeting_summaries !== false;
                document.getElementById('use-gemini-enhancement').checked = settings.transcription.use_gemini_enhancement || false;
                document.getElementById('gemini-api-key').value = settings.transcription.gemini_api_key || '';
            }
            
            // Interface settings
            if (settings.interface) {
                document.getElementById('theme').value = settings.interface.theme || 'dark';
                document.getElementById('font-size').value = settings.interface.font_size || 'medium';
                document.getElementById('auto-scroll-transcript').checked = settings.interface.auto_scroll_transcript !== false;
            }
        }
        
        function collectSettingsFromForm() {
            return {
                audio: {
                    microphone_source: document.getElementById('microphone-source').value,
                    input_gain: parseFloat(document.getElementById('input-gain').value),
                    noise_suppression: document.getElementById('noise-suppression').value,
                    voice_activity_detection: document.getElementById('voice-activity-detection').checked,
                    recording_format: document.getElementById('recording-format').value
                },
                transcription: {
                    transcription_language: document.getElementById('transcription-language').value,
                    whisper_model: document.getElementById('whisper-model').value,
                    custom_vocabulary: document.getElementById('custom-vocabulary').value,
                    automatic_punctuation: document.getElementById('automatic-punctuation').checked,
                    post_meeting_summaries: document.getElementById('post-meeting-summaries').checked,
                    use_gemini_enhancement: document.getElementById('use-gemini-enhancement').checked,
                    gemini_api_key: document.getElementById('gemini-api-key').value
                },
                interface: {
                    theme: document.getElementById('theme').value,
                    font_size: document.getElementById('font-size').value,
                    auto_scroll_transcript: document.getElementById('auto-scroll-transcript').checked
                }
            };
        }
        
        async function saveSettings() {
            try {
                const settings = collectSettingsFromForm();
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showMessage('Settings saved successfully!', 'success');
                    currentSettings = settings;
                } else {
                    showMessage('Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('Error saving settings', 'error');
            }
        }
        
        async function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/settings/reset', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showMessage('Settings reset to defaults', 'success');
                        loadSettings(); // Reload the form with defaults
                    } else {
                        showMessage('Failed to reset settings', 'error');
                    }
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showMessage('Error resetting settings', 'error');
                }
            }
        }
        
        // Show message to user
        function showMessage(message, type) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 12px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
                font-size: 18px;
            `;
            
            if (type === 'success') {
                messageEl.style.backgroundColor = '#10B981';
            } else if (type === 'error') {
                messageEl.style.backgroundColor = '#EF4444'; 
            } else {
                messageEl.style.backgroundColor = '#6B7280';
            }
            
            messageEl.textContent = message;
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 4000);
        }
        
        // Stop recording from header timer (if active)
        async function stopRecordingFromHeader() {
            try {
                const response = await fetch('/api/recording/stop', { method: 'POST' });
                if (response.ok) {
                    showMessage('Recording stopped', 'success');
                } else {
                    showMessage('Failed to stop recording', 'error');
                }
            } catch (error) {
                showMessage('Error stopping recording', 'error');
                console.error('Error:', error);
            }
        }
        
        // Reload app function
        async function reloadApp() {
            if (confirm('Are you sure you want to reload the app? This will restart the server.')) {
                try {
                    showMessage('Reloading app...', 'info');
                    const response = await fetch('/api/restart', { method: 'POST' });
                    if (response.ok) {
                        showMessage('App is restarting... Please wait', 'info');
                        
                        // Wait longer for server to restart, then retry connection
                        setTimeout(() => {
                            let retries = 0;
                            const maxRetries = 20;
                            
                            const checkServer = () => {
                                fetch('/api/status')
                                    .then(response => {
                                        if (response.ok) {
                                            // Server is back up, reload page
                                            window.location.reload();
                                        } else {
                                            throw new Error('Server not ready');
                                        }
                                    })
                                    .catch(() => {
                                        retries++;
                                        if (retries < maxRetries) {
                                            // Try again in 1 second
                                            setTimeout(checkServer, 1000);
                                        } else {
                                            showMessage('Server restart taking longer than expected. Please refresh manually.', 'warning');
                                        }
                                    });
                            };
                            
                            checkServer();
                        }, 5000); // Wait 5 seconds before first check
                    } else {
                        showMessage('Failed to restart app', 'error');
                    }
                } catch (error) {
                    console.error('Error restarting app:', error);
                    showMessage('Error restarting app', 'error');
                }
            }
        }
        
        // Navigation functions
        function goToControlsView() {
            window.location.href = '/?view=controls';
        }
        
        // Connection status indicator update
        function updateStatusIndicator(connected = true) {
            const statusIndicator = document.getElementById('status-indicator');
            if (statusIndicator) {
                if (connected) {
                    statusIndicator.className = 'w-6 h-6 text-green-400';
                } else {
                    statusIndicator.className = 'w-6 h-6 text-red-400';
                }
            }
        }
        
        // WebSocket event handlers for recording status
        socket.on('connect', () => {
            updateStatusIndicator(true);
        });
        
        socket.on('disconnect', () => {
            updateStatusIndicator(false);
        });
        
        socket.on('recording_started', (data) => {
            const headerTimer = document.getElementById('header-recording-timer');
            if (headerTimer) {
                headerTimer.classList.remove('hidden');
            }
        });
        
        socket.on('recording_stopped', (data) => {
            const headerTimer = document.getElementById('header-recording-timer');
            if (headerTimer) {
                headerTimer.classList.add('hidden');
            }
        });
        
        socket.on('recording_timer', (data) => {
            const headerTimerDisplay = document.getElementById('header-timer-display');
            if (headerTimerDisplay) {
                const duration = data.duration;
                const h = Math.floor(duration / 3600);
                const m = Math.floor((duration % 3600) / 60);
                const s = Math.floor(duration % 60);
                headerTimerDisplay.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        });
        
        // Bluetooth status updates
        socket.on('bluetooth_device_connected', (data) => {
            showMessage(`Bluetooth device ${data.name} connected`, 'success');
            loadBluetoothDevices();
        });
        
        socket.on('bluetooth_device_disconnected', (data) => {
            showMessage(`Bluetooth device ${data.name} disconnected`, 'info');
            loadBluetoothDevices();
        });
        
        socket.on('bluetooth_status_update', (data) => {
            loadBluetoothDevices();
        });

        // Touch scrolling optimization for Raspberry Pi
        function setupTouchScrolling() {
            // Prevent touch event conflicts
            document.addEventListener('touchstart', function(e) {
                // Allow native scrolling on scroll containers
                if (e.target.closest('.touch-scroll-container')) {
                    e.stopPropagation();
                }
            }, { passive: true });

            // Optimize scroll performance with throttling
            const scrollContainers = document.querySelectorAll('.touch-scroll-container');
            scrollContainers.forEach(container => {
                container.addEventListener('scroll', throttle(function() {
                    // Optional: Add scroll indicator or other visual feedback
                }, 16), { passive: true });
            });
        }

        // Throttle function for performance
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Initialize touch scrolling
        setupTouchScrolling();
    </script>
</body>
</html>