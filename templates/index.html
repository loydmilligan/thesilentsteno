<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover, touch-action=pan-y">
    <title>Silent Steno - Meeting Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Modern touch scrolling for Raspberry Pi */
        .touch-scroll-container {
            overflow-y: auto;
            scroll-behavior: smooth;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: auto;
            touch-action: pan-y pinch-zoom;
            height: 100%;
            max-height: 100%;
            /* Force hardware acceleration on Pi */
            transform: translateZ(0);
            will-change: scroll-position;
        }
        
        /* Ensure scrollable content extends beyond viewport */
        .scrollable-content {
            min-height: calc(100% + 1px);
            padding-bottom: 20px;
        }
        
        /* Hide scrollbar on touch devices but keep functionality */
        @media (pointer: coarse) {
            .touch-scroll-container::-webkit-scrollbar {
                width: 0;
                background: transparent;
            }
            .touch-scroll-container {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
        }
        
        /* Raspberry Pi specific optimizations */
        @media screen and (max-device-width: 1024px) {
            .touch-scroll-container {
                transform: translate3d(0, 0, 0);
                -webkit-transform: translate3d(0, 0, 0);
            }
        }
        
        /* Show thin scrollbar on desktop */
        @media (pointer: fine) {
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #1e293b;
            }
            ::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }
        }
        .waveform-bar {
            animation: wave 1.5s infinite ease-in-out;
            transform-origin: bottom;
        }
        @keyframes wave {
            0%, 100% { transform: scaleY(0.1); }
            50% { transform: scaleY(1); }
        }
        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            80% { transform: scale(1.2); opacity: 0; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        
        /* Pi Touchscreen Optimizations (1024x600) */
        @media (max-width: 1024px) and (max-height: 600px) {
            .text-4xl { font-size: 2rem; }
            .text-3xl { font-size: 1.75rem; }
            .text-2xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.25rem; }
            .p-8 { padding: 1rem; }
            .p-6 { padding: 0.75rem; }
            .p-4 { padding: 0.5rem; }
            .mb-8 { margin-bottom: 1rem; }
            .mb-6 { margin-bottom: 0.75rem; }
            .space-y-6 > * + * { margin-top: 0.75rem; }
            .h-64 { height: 12rem; }
            .min-h-screen { min-height: 600px; }
        }
        
        /* Touch-friendly buttons */
        .touch-button {
            min-height: 48px;
            min-width: 48px;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="h-full antialiased text-slate-200">
    <div id="app" class="h-screen w-full max-w-4xl mx-auto flex flex-col">

        <!-- App Header -->
        <header class="flex items-center justify-between p-4 bg-slate-900/80 backdrop-blur-sm border-b border-slate-700/50 sticky top-0 z-10">
            <div id="header-left" class="flex items-center gap-4">
                <button onclick="window.location.href='/settings'" class="p-3 rounded-full hover:bg-slate-700 transition-colors" title="Settings">
                    <svg class="w-8 h-8 text-slate-300 hover:text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                    </svg>
                </button>
                <button onclick="reloadApp()" class="p-3 rounded-full hover:bg-slate-700 transition-colors" title="Reload App (Debug)">
                    <svg class="w-8 h-8 text-slate-300 hover:text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,12H10V10H14M14,16H10V14H14M20,8H17.19C16.74,7.22 16.12,6.55 15.37,6.04L17,4.41L15.59,3L13.42,5.17C12.96,5.06 12.5,5 12,5C11.5,5 11.04,5.06 10.59,5.17L8.41,3L7,4.41L8.62,6.04C7.88,6.55 7.26,7.22 6.81,8H4V10H6.09C6.04,10.33 6,10.66 6,11V12H4V14H6V15C6,15.34 6.04,15.67 6.09,16H4V18H6.81C7.85,19.79 9.78,21 12,21C14.22,21 16.15,19.79 17.19,18H20V16H17.91C17.96,15.67 18,15.34 18,15V14H20V12H18V11C18,10.66 17.96,10.33 17.91,10H20V8Z"/>
                    </svg>
                </button>
                <button id="back-button" class="hidden p-2 rounded-full hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </button>
                <h1 id="header-title" class="text-3xl font-bold text-white">Sessions</h1>
                <button id="delete-session-button" class="hidden p-2 rounded-full hover:bg-red-600 transition-colors ml-4" title="Delete Session">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3,6 5,6 21,6"></polyline><path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2,-2V6m3,0V4a2,2 0 0,1,2,-2h4a2,2 0 0,1,2,2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>
            <div id="header-right" class="flex items-center gap-4">
                <button id="controls-nav-btn" onclick="showControlsView()" class="bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200">
                    Live
                </button>
                <button id="sessions-nav-btn" onclick="window.location.href='/'" class="bg-gradient-to-r from-blue-500 to-blue-400 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transform scale-105 border-2 border-blue-300">
                    Sessions
                </button>
                <button id="dashboard-nav-btn" onclick="window.location.href='/dashboard'" class="bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200">
                    Dashboard
                </button>
                <div id="status-indicator" class="w-6 h-6 text-green-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg>
                </div>
                <!-- Recording Timer for Header (clickable to stop) -->
                <div id="header-recording-timer" class="hidden bg-red-600 hover:bg-red-700 text-white font-mono font-bold py-2 px-4 rounded-lg text-sm cursor-pointer transition-colors" onclick="stopRecordingFromHeader()" title="Click to stop recording">
                    REC: <span id="header-timer-display">00:00:00</span>
                    <svg class="inline-block w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18,18H6V6H18V18Z"/>
                    </svg>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 touch-scroll-container p-4 md:p-6 relative">
            
            <!-- View: Session List -->
            <div id="session-list-view">
                <div id="session-list" class="space-y-4 scrollable-content">
                    <div class="text-center py-8">
                        <p class="text-slate-400">Loading sessions...</p>
                    </div>
                </div>
            </div>

            <!-- View: Live Recording -->
            <div id="live-recording-view" class="hidden h-full flex flex-col p-6">
                <!-- Top Section: Large Action Buttons -->
                <div class="flex-1 flex items-center justify-center gap-8 mb-6">
                    <!-- Left Button: Start Recording -->
                    <button id="left-action-btn" onclick="toggleRecording()" class="flex-1 max-w-md h-48 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-3xl shadow-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center">
                        <svg id="left-btn-icon" class="w-20 h-20 text-white mb-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2A3 3 0 0 0 9 5V11A3 3 0 0 0 12 14A3 3 0 0 0 15 11V5A3 3 0 0 0 12 2M19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H7A5 5 0 0 0 12 16A5 5 0 0 0 17 11H19Z"/>
                        </svg>
                        <span id="left-btn-text" class="text-3xl font-bold text-white">START REC</span>
                    </button>
                    
                    <!-- Center: Recording Indicator -->
                    <div class="flex flex-col items-center justify-center px-8">
                        <div id="recording-status-indicator" class="w-24 h-24 bg-slate-700 rounded-full flex items-center justify-center mb-4">
                            <div id="recording-pulse" class="hidden w-20 h-20 bg-red-500 rounded-full animate-pulse flex items-center justify-center">
                                <div class="w-12 h-12 bg-red-700 rounded-full"></div>
                            </div>
                            <svg id="ready-mic-icon" class="w-16 h-16 text-slate-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2A3 3 0 0 0 9 5V11A3 3 0 0 0 12 14A3 3 0 0 0 15 11V5A3 3 0 0 0 12 2M19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H7A5 5 0 0 0 12 16A5 5 0 0 0 17 11H19Z"/>
                            </svg>
                        </div>
                        <p id="recording-timer-display" class="text-4xl font-mono text-red-400 font-bold hidden">00:00:00</p>
                        <p id="ready-status" class="text-2xl text-slate-400 font-medium">Ready</p>
                    </div>
                    
                    <!-- Right Button: Sessions -->
                    <button id="right-action-btn" onclick="showView('list')" class="flex-1 max-w-md h-48 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-3xl shadow-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center">
                        <svg class="w-20 h-20 text-white mb-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M4 6H2V20C2 21.11 2.89 22 4 22H18V20H4V6M20 2H8C6.89 2 6 2.89 6 4V16C6 17.11 6.89 18 8 18H20C21.11 18 22 17.11 22 16V4C22 2.89 21.11 2 20 2M20 16H8V4H20V16M18 14V6H16V14H18M14 14V6H10V14H14Z"/>
                        </svg>
                        <span class="text-3xl font-bold text-white">SESSIONS</span>
                    </button>
                </div>
                
                <!-- Live Transcript Scroll Area -->
                <div class="bg-slate-800/50 backdrop-blur rounded-3xl p-6 h-32 overflow-hidden">
                    <div id="live-transcript-scroll" class="text-2xl text-white font-medium leading-relaxed whitespace-nowrap">
                        <span id="live-transcript-text" class="inline-block">Waiting for audio input...</span>
                    </div>
                </div>
            </div>

            <!-- View: Session Details -->
            <div id="session-detail-view" class="hidden">
                <div class="space-y-6">
                    <!-- Playback Controls -->
                    <div class="bg-slate-800 p-4 rounded-xl space-y-3">
                        <div class="flex items-center gap-4">
                            <button id="play-button" class="p-3 bg-violet-600 hover:bg-violet-700 rounded-full text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            </button>
                            <div class="flex-1">
                                <div class="w-full h-2 bg-slate-700 rounded-full">
                                    <div id="playback-progress" class="w-0 h-full bg-violet-500 rounded-full transition-all duration-300"></div>
                                </div>
                            </div>
                            <span id="playback-time" class="text-sm font-mono text-slate-400">00:00 / 00:00</span>
                        </div>
                        <audio id="audio-player" class="hidden"></audio>
                    </div>

                    <!-- Participants -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Participants</h2>
                        <div id="detail-participants" class="flex flex-wrap gap-2">
                            <!-- Participants will be injected here -->
                        </div>
                    </div>

                    <!-- AI Summary -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Summary</h2>
                        <p id="detail-summary" class="bg-slate-800 p-4 rounded-xl text-slate-300 leading-relaxed"></p>
                    </div>

                    <!-- Action Items -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Action Items</h2>
                        <ul id="detail-action-items" class="bg-slate-800 p-4 rounded-xl space-y-3 list-none">
                            <!-- Action items will be injected here -->
                        </ul>
                    </div>
                    
                    <!-- Key Moments -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Key Moments</h2>
                        <div id="detail-key-moments" class="bg-slate-800 p-4 rounded-xl space-y-3">
                           <!-- Key moments will be injected here -->
                        </div>
                    </div>

                    <!-- Full Transcript -->
                    <div>
                        <button id="toggle-transcript-button" class="w-full text-left font-semibold text-white p-4 bg-slate-800 rounded-xl hover:bg-slate-700 transition-colors flex justify-between items-center">
                            <span>Full Transcript</span>
                            <svg id="transcript-chevron" class="w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="detail-transcript-container" class="hidden mt-2 bg-slate-800 p-4 rounded-xl h-96 touch-scroll-container">
                            <div id="detail-transcript" class="space-y-4 text-slate-300">
                                <!-- Transcript will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Action Button - Hidden in sessions view -->
        <div id="fab-container" class="hidden absolute bottom-6 right-6 z-20">
            <div class="relative">
                <div id="fab-pulse-ring" class="absolute inset-0 bg-red-600 rounded-full pulse-ring hidden"></div>
                <button id="record-button" class="touch-button bg-violet-600 hover:bg-violet-700 active:bg-violet-800 text-white p-6 rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all duration-200 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages" class="fixed bottom-4 left-4 z-30 space-y-2">
            <!-- Status messages will be injected here -->
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Global state
        let sessions = [];
        let currentSession = null;
        let isRecording = false;
        let audioPlayer = null;
        let recordingInterval = null;
        let recordingTimer = { duration: 0 };
        
        // Navigation function
        function showControlsView() {
            showView('controls');
            updateControlsView();
            loadRecentSessions();
        }
        
        // Update navigation buttons based on current view
        function updateNavigation(currentView) {
            const sessionsBtn = document.getElementById('sessions-nav-btn');
            const controlsBtn = document.getElementById('controls-nav-btn');
            const dashboardBtn = document.getElementById('dashboard-nav-btn');
            
            // Reset all buttons to inactive state
            const controlsInactiveClass = 'bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200';
            const controlsActiveClass = 'bg-gradient-to-r from-purple-500 to-purple-400 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transform scale-105 border-2 border-purple-300';
            const sessionsInactiveClass = 'bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200';
            const sessionsActiveClass = 'bg-gradient-to-r from-blue-500 to-blue-400 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transform scale-105 border-2 border-blue-300';
            const dashboardInactiveClass = 'bg-slate-600 hover:bg-slate-700 text-slate-300 hover:text-white font-bold py-4 px-8 rounded-lg text-2xl transition-all duration-200';
            const dashboardActiveClass = 'bg-gradient-to-r from-slate-500 to-slate-400 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transform scale-105 border-2 border-slate-300';
            
            controlsBtn.className = controlsInactiveClass;
            sessionsBtn.className = sessionsInactiveClass;
            dashboardBtn.className = dashboardInactiveClass;
            
            // Highlight current view
            if (currentView === 'list') {
                sessionsBtn.className = sessionsActiveClass;
            } else if (currentView === 'controls') {
                controlsBtn.className = controlsActiveClass;
            }
            // Dashboard active state is handled in its own template
        }
        
        // Update recording visuals
        function updateRecordingVisuals() {
            const recordButton = document.getElementById('record-button');
            const fabPulseRing = document.getElementById('fab-pulse-ring');
            const headerTimer = document.getElementById('header-recording-timer');
            
            if (isRecording) {
                recordButton.classList.remove('bg-violet-600', 'hover:bg-violet-700');
                recordButton.classList.add('bg-red-600', 'hover:bg-red-700');
                fabPulseRing.classList.remove('hidden');
                headerTimer.classList.remove('hidden');
            } else {
                recordButton.classList.add('bg-violet-600', 'hover:bg-violet-700');
                recordButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                fabPulseRing.classList.add('hidden');
                headerTimer.classList.add('hidden');
            }
        }

        // DOM elements
        const views = {
            list: document.getElementById('session-list-view'),
            controls: document.getElementById('live-recording-view'), // Now the controls view
            detail: document.getElementById('session-detail-view')
        };
        
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');
        const recordButton = document.getElementById('record-button');
        const fabContainer = document.getElementById('fab-container');
        const sessionListContainer = document.getElementById('session-list');
        const toggleTranscriptButton = document.getElementById('toggle-transcript-button');
        const transcriptContainer = document.getElementById('detail-transcript-container');
        const transcriptChevron = document.getElementById('transcript-chevron');
        const statusIndicator = document.getElementById('status-indicator');
        const statusMessages = document.getElementById('status-messages');
        const audioPlayerElement = document.getElementById('audio-player');
        const playButton = document.getElementById('play-button');
        const playbackProgress = document.getElementById('playback-progress');
        const playbackTime = document.getElementById('playback-time');

        // Utility functions
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return h > 0 ? `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `px-4 py-2 rounded-lg text-white font-medium ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'} transform transition-all duration-300 translate-y-full opacity-0`;
            messageEl.textContent = message;
            statusMessages.appendChild(messageEl);
            
            // Animate in
            setTimeout(() => {
                messageEl.classList.remove('translate-y-full', 'opacity-0');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                messageEl.classList.add('translate-y-full', 'opacity-0');
                setTimeout(() => messageEl.remove(), 300);
            }, 3000);
        }

        function updateStatusIndicator(connected = true) {
            if (connected) {
                statusIndicator.className = 'w-6 h-6 text-green-400';
            } else {
                statusIndicator.className = 'w-6 h-6 text-red-400';
            }
        }

        // View management
        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
            
            backButton.classList.toggle('hidden', viewName === 'list');
            fabContainer.classList.add('hidden'); // Always hide FAB in sessions view
            headerTitle.textContent = viewName === 'list' ? 'Sessions' : viewName === 'controls' ? 'Live' : '';
            
            // Show/hide delete button only in detail view
            document.getElementById('delete-session-button').classList.toggle('hidden', viewName !== 'detail');
            
            // Update navigation buttons
            updateNavigation(viewName);
        }

        // Session management
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    sessions = await response.json();
                    renderSessionList();
                } else {
                    showMessage('Failed to load sessions', 'error');
                }
            } catch (error) {
                showMessage('Error loading sessions', 'error');
                console.error('Error loading sessions:', error);
            }
        }

        function renderSessionList() {
            sessionListContainer.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionListContainer.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-slate-400 text-xl">No sessions found. Use the Live screen to start your first session.</p>
                    </div>
                `;
                return;
            }

            sessions.sort((a, b) => new Date(b.start_time) - new Date(a.start_time)).forEach(session => {
                const card = document.createElement('div');
                card.className = 'bg-slate-800 p-6 rounded-2xl shadow-lg cursor-pointer hover:bg-slate-700/70 transition-colors duration-200 border-2 border-slate-700';
                card.dataset.sessionId = session.session_id;

                const date = new Date(session.start_time);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const durationMinutes = Math.floor(session.duration / 60);

                const participantAvatars = session.participants.map(p => 
                    `<div class="w-12 h-12 rounded-full bg-violet-500 flex items-center justify-center text-white font-bold text-lg border-2 border-slate-800 -ml-2">${p.charAt(0)}</div>`
                ).join('');
                
                // Determine session status indicators
                const hasTranscript = session.transcript && session.transcript.length > 0;
                const hasAnalysis = session.action_items && session.action_items.length > 0;
                const meetingTone = session.sentiment || 'neutral';
                
                // Create status indicators
                const statusIndicators = [];
                
                if (hasTranscript) {
                    statusIndicators.push('<div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center" title="Transcribed"><svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>');
                }
                
                if (hasAnalysis) {
                    statusIndicators.push('<div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center" title="AI Analysis Complete"><svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>');
                }
                
                // Meeting tone indicator
                let toneColor = 'bg-gray-500';
                let toneIcon = 'üòê';
                if (meetingTone === 'positive') {
                    toneColor = 'bg-green-500';
                    toneIcon = 'üòä';
                } else if (meetingTone === 'negative') {
                    toneColor = 'bg-red-500';
                    toneIcon = 'üòî';
                } else if (meetingTone === 'neutral') {
                    toneColor = 'bg-yellow-500';
                    toneIcon = 'üòê';
                }
                
                statusIndicators.push(`<div class="w-6 h-6 ${toneColor} rounded-full flex items-center justify-center text-white text-xs" title="Meeting Tone: ${meetingTone}">${toneIcon}</div>`);
                
                const statusHtml = statusIndicators.length > 0 ? 
                    `<div class="flex items-center gap-2 mt-2">${statusIndicators.join('')}</div>` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-2xl font-bold text-white mb-2">${session.title}</h3>
                            <p class="text-lg text-slate-400 mb-2">${formattedDate} ‚Ä¢ ${durationMinutes} min</p>
                            ${statusHtml}
                        </div>
                        <div class="flex items-center -space-x-2">
                            ${participantAvatars}
                        </div>
                    </div>
                    <p class="text-slate-300 text-lg leading-relaxed">${session.summary}</p>
                `;
                
                card.addEventListener('click', () => renderSessionDetail(session.session_id));
                sessionListContainer.appendChild(card);
            });
        }

        function renderSessionDetail(sessionId) {
            const session = sessions.find(s => s.session_id === sessionId);
            if (!session) return;

            currentSession = session;
            showView('detail');
            headerTitle.textContent = session.title;
            
            // Show delete button for session detail view
            document.getElementById('delete-session-button').classList.remove('hidden');

            // Populate participants
            document.getElementById('detail-participants').innerHTML = session.participants.map(p => 
                `<span class="bg-slate-700 text-slate-200 px-3 py-1 rounded-full text-sm font-medium">${p}</span>`
            ).join('');

            // Populate summary
            document.getElementById('detail-summary').textContent = session.summary;

            // Populate action items
            const actionItemsList = document.getElementById('detail-action-items');
            actionItemsList.innerHTML = session.action_items.length > 0 ? session.action_items.map(item => `
                <li class="flex items-start gap-3">
                    <div class="w-5 h-5 border-2 border-slate-500 rounded mt-1 flex-shrink-0"></div>
                    <span>${item}</span>
                </li>
            `).join('') : '<li class="text-slate-400">No action items identified.</li>';
            
            // Populate key moments
            const keyMomentsContainer = document.getElementById('detail-key-moments');
            keyMomentsContainer.innerHTML = session.key_moments.length > 0 ? session.key_moments.map(moment => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50 cursor-pointer">
                    <div class="bg-violet-600 text-white text-xs font-mono px-2 py-1 rounded">${moment.timestamp}</div>
                    <div class="text-slate-300">${moment.description}</div>
                </div>
            `).join('') : '<p class="text-slate-400">No key moments identified.</p>';

            // Populate transcript
            const transcriptList = document.getElementById('detail-transcript');
            transcriptList.innerHTML = session.transcript.map(entry => `
                <div>
                    <p class="font-semibold text-violet-400 mb-1">${entry.speaker} <span class="text-xs text-slate-500 font-mono">${entry.timestamp}</span></p>
                    <p class="pl-2">${entry.text}</p>
                </div>
            `).join('');
            
            // Reset transcript visibility
            transcriptContainer.classList.add('hidden');
            transcriptChevron.classList.remove('rotate-180');

            // Set up audio player
            if (session.wav_file) {
                audioPlayerElement.src = `/api/play/${session.session_id}`;
                setupAudioPlayer();
            }
        }

        function setupAudioPlayer() {
            audioPlayerElement.addEventListener('loadedmetadata', () => {
                const duration = audioPlayerElement.duration;
                playbackTime.textContent = `00:00 / ${formatTime(duration)}`;
            });

            audioPlayerElement.addEventListener('timeupdate', () => {
                const currentTime = audioPlayerElement.currentTime;
                const duration = audioPlayerElement.duration;
                const progress = (currentTime / duration) * 100;
                playbackProgress.style.width = `${progress}%`;
                playbackTime.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            });

            audioPlayerElement.addEventListener('ended', () => {
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                playbackProgress.style.width = '0%';
            });
        }

        // Recording management (now handled by controls view)

        async function startRecording() {
            try {
                const response = await fetch('/api/recording/start', { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    isRecording = true;
                    updateRecordingVisuals();
                    updateControlsView();
                    showMessage('Recording started', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to start recording', 'error');
                }
            } catch (error) {
                showMessage('Error starting recording', 'error');
                console.error('Error starting recording:', error);
            }
        }
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function stopRecording() {
            try {
                const response = await fetch('/api/recording/stop', { method: 'POST' });
                if (response.ok) {
                    isRecording = false;
                    updateRecordingVisuals();
                    updateControlsView();
                    showMessage('Recording stopped. Transcribing...', 'success');
                    loadSessions(); // Refresh session list
                    loadRecentSessions(); // Refresh recent sessions in controls view
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to stop recording', 'error');
                }
            } catch (error) {
                showMessage('Error stopping recording', 'error');
                console.error('Error stopping recording:', error);
            }
        }
        
        // Stop recording from header timer (available on all screens)
        async function stopRecordingFromHeader() {
            try {
                showMessage('Stopping recording...', 'info');
                await stopRecording();
            } catch (error) {
                showMessage('Error stopping recording from header', 'error');
                console.error('Error stopping recording from header:', error);
            }
        }
        
        // Reload app function
        async function reloadApp() {
            if (confirm('Are you sure you want to reload the app? This will restart the server.')) {
                try {
                    showMessage('Reloading app...', 'info');
                    const response = await fetch('/api/restart', { method: 'POST' });
                    if (response.ok) {
                        showMessage('App is restarting... Please wait', 'info');
                        
                        // Wait longer for server to restart, then retry connection
                        setTimeout(() => {
                            let retries = 0;
                            const maxRetries = 20;
                            
                            const checkServer = () => {
                                fetch('/api/status')
                                    .then(response => {
                                        if (response.ok) {
                                            // Server is back up, reload page
                                            window.location.reload();
                                        } else {
                                            throw new Error('Server not ready');
                                        }
                                    })
                                    .catch(() => {
                                        retries++;
                                        if (retries < maxRetries) {
                                            // Try again in 1 second
                                            setTimeout(checkServer, 1000);
                                        } else {
                                            showMessage('Server restart taking longer than expected. Please refresh manually.', 'warning');
                                        }
                                    });
                            };
                            
                            checkServer();
                        }, 5000); // Wait 5 seconds before first check
                    } else {
                        showMessage('Failed to restart app', 'error');
                    }
                } catch (error) {
                    console.error('Error restarting app:', error);
                    showMessage('Error restarting app', 'error');
                }
            }
        }

        // Get recording status on page load
        async function checkInitialRecordingStatus() {
            try {
                const response = await fetch('/api/recording/status');
                if (response.ok) {
                    const status = await response.json();
                    isRecording = status.is_recording;
                    if (status.duration) {
                        recordingTimer.duration = status.duration;
                    }
                    updateRecordingVisuals();
                    updateControlsView();
                }
            } catch (error) {
                console.error('Error checking initial recording status:', error);
            }
        }
        
        // Socket.IO event handlers
        socket.on('connect', () => {
            updateStatusIndicator(true);
            showMessage('Connected to server', 'success');
            checkInitialRecordingStatus(); // Check recording status on connect
        });

        socket.on('disconnect', () => {
            updateStatusIndicator(false);
            showMessage('Disconnected from server', 'error');
        });

        socket.on('recording_timer', (data) => {
            recordingTimer.duration = data.duration;
            if (isRecording) {
                const timerEl = document.getElementById('recording-timer');
                const headerTimerEl = document.getElementById('header-timer-display');
                const liveTimerEl = document.getElementById('recording-timer-display');
                
                const formattedTime = formatTime(data.duration);
                
                if (timerEl) {
                    timerEl.textContent = formattedTime;
                }
                if (headerTimerEl) {
                    headerTimerEl.textContent = formattedTime;
                }
                if (liveTimerEl) {
                    liveTimerEl.textContent = formattedTime;
                }
            }
        });

        socket.on('transcription_complete', (data) => {
            showMessage('Transcription complete!', 'success');
            loadSessions(); // Refresh session list
        });

        socket.on('transcription_error', (data) => {
            showMessage('Transcription failed', 'error');
        });
        
        socket.on('recording_started', (data) => {
            isRecording = true;
            updateRecordingVisuals();
            updateControlsView();
        });
        
        socket.on('recording_stopped', (data) => {
            isRecording = false;
            updateRecordingVisuals();
            updateControlsView();
        });

        // Update controls view based on recording state
        function updateControlsView() {
            const leftActionBtn = document.getElementById('left-action-btn');
            const leftBtnIcon = document.getElementById('left-btn-icon');
            const leftBtnText = document.getElementById('left-btn-text');
            const recordingPulse = document.getElementById('recording-pulse');
            const readyMicIcon = document.getElementById('ready-mic-icon');
            const recordingTimerDisplay = document.getElementById('recording-timer-display');
            const readyStatus = document.getElementById('ready-status');
            const liveTranscriptText = document.getElementById('live-transcript-text');
            
            if (isRecording) {
                // Recording state - Change left button to STOP
                leftActionBtn.className = 'flex-1 max-w-md h-48 bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-3xl shadow-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center';
                leftBtnIcon.innerHTML = '<path d="M18,18H6V6H18V18Z"/>';
                leftBtnText.textContent = 'STOP REC';
                
                // Show recording indicator
                recordingPulse.classList.remove('hidden');
                readyMicIcon.classList.add('hidden');
                recordingTimerDisplay.classList.remove('hidden');
                readyStatus.classList.add('hidden');
                
                // Update live transcript
                liveTranscriptText.textContent = 'Recording in progress... Live transcription will appear here...';
                
            } else {
                // Ready state - Change left button back to START
                leftActionBtn.className = 'flex-1 max-w-md h-48 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-3xl shadow-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 flex flex-col items-center justify-center';
                leftBtnIcon.innerHTML = '<path d="M12 2A3 3 0 0 0 9 5V11A3 3 0 0 0 12 14A3 3 0 0 0 15 11V5A3 3 0 0 0 12 2M19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H7A5 5 0 0 0 12 16A5 5 0 0 0 17 11H19Z"/>';
                leftBtnText.textContent = 'START REC';
                
                // Show ready indicator
                recordingPulse.classList.add('hidden');
                readyMicIcon.classList.remove('hidden');
                recordingTimerDisplay.classList.add('hidden');
                readyStatus.classList.remove('hidden');
                
                // Reset live transcript
                liveTranscriptText.textContent = 'Waiting for audio input...';
            }
        }
        
        // Load recent sessions for controls view
        async function loadRecentSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    const allSessions = await response.json();
                    const recentSessions = allSessions
                        .sort((a, b) => new Date(b.start_time) - new Date(a.start_time))
                        .slice(0, 5); // Show only 5 most recent
                    
                    const recentSessionsList = document.getElementById('recent-sessions-list');
                    
                    if (recentSessions.length === 0) {
                        recentSessionsList.innerHTML = '<p class="text-slate-400 text-sm">No recent sessions</p>';
                        return;
                    }
                    
                    recentSessionsList.innerHTML = recentSessions.map(session => {
                        const date = new Date(session.start_time);
                        const timeAgo = getTimeAgo(date);
                        const duration = Math.floor(session.duration / 60);
                        
                        return `
                            <div class="bg-slate-700/50 p-3 rounded-xl cursor-pointer hover:bg-slate-700 transition-colors" 
                                 onclick="renderSessionDetail('${session.session_id}')">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <h4 class="text-white font-medium text-sm truncate">${session.title}</h4>
                                        <p class="text-slate-400 text-xs">${timeAgo} ‚Ä¢ ${duration} min</p>
                                    </div>
                                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading recent sessions:', error);
            }
        }
        
        // Helper function to get relative time
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            
            return "Just now";
        }

        // Event listeners
        backButton.addEventListener('click', () => showView('list'));
        recordButton.addEventListener('click', () => {
            // Navigate to controls view when blue mic button is pressed
            showControlsView();
        });
        
        playButton.addEventListener('click', () => {
            if (audioPlayerElement.paused) {
                audioPlayerElement.play();
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
            } else {
                audioPlayerElement.pause();
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
            }
        });
        
        toggleTranscriptButton.addEventListener('click', () => {
            transcriptContainer.classList.toggle('hidden');
            transcriptChevron.classList.toggle('rotate-180');
        });

        // Delete session button
        document.getElementById('delete-session-button').addEventListener('click', async () => {
            if (!currentSession) return;
            
            if (confirm(`Are you sure you want to delete "${currentSession.title}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/sessions/${currentSession.session_id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showMessage('Session deleted successfully', 'success');
                        showView('list'); // Go back to session list
                        loadSessions(); // Refresh the session list
                    } else {
                        const errorData = await response.json();
                        showMessage(errorData.error || 'Failed to delete session', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting session:', error);
                    showMessage('Error deleting session', 'error');
                }
            }
        });

        // Touch scrolling optimization for Raspberry Pi
        function setupTouchScrolling() {
            // Prevent touch event conflicts
            document.addEventListener('touchstart', function(e) {
                // Allow native scrolling on scroll containers
                if (e.target.closest('.touch-scroll-container')) {
                    e.stopPropagation();
                }
            }, { passive: true });

            // Optimize scroll performance with throttling
            const scrollContainers = document.querySelectorAll('.touch-scroll-container');
            scrollContainers.forEach(container => {
                container.addEventListener('scroll', throttle(function() {
                    // Optional: Add scroll indicator or other visual feedback
                }, 16), { passive: true });
            });
        }

        // Throttle function for performance
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // Initialize the app
        loadSessions();
        loadRecentSessions();
        checkInitialRecordingStatus(); // Check recording status on page load
        setupTouchScrolling(); // Initialize touch scrolling
        
        // Check URL parameters for direct navigation
        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        
        if (viewParam === 'controls') {
            showControlsView();
        } else {
            showView('list');
        }
    </script>
</body>
</html>