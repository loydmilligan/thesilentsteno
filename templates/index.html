<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Silent Steno - Meeting Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Touch-friendly scrolling */
        .touch-scrollable {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        /* Hide scrollbar on touch devices but keep functionality */
        @media (pointer: coarse) {
            .touch-scrollable::-webkit-scrollbar {
                width: 0;
                background: transparent;
            }
            .touch-scrollable {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
        }
        
        /* Show thin scrollbar on desktop */
        @media (pointer: fine) {
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #1e293b;
            }
            ::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #64748b;
            }
        }
        .waveform-bar {
            animation: wave 1.5s infinite ease-in-out;
            transform-origin: bottom;
        }
        @keyframes wave {
            0%, 100% { transform: scaleY(0.1); }
            50% { transform: scaleY(1); }
        }
        .pulse-ring {
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            80% { transform: scale(1.2); opacity: 0; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        
        /* Pi Touchscreen Optimizations (1024x600) */
        @media (max-width: 1024px) and (max-height: 600px) {
            .text-4xl { font-size: 2rem; }
            .text-3xl { font-size: 1.75rem; }
            .text-2xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.25rem; }
            .p-8 { padding: 1rem; }
            .p-6 { padding: 0.75rem; }
            .p-4 { padding: 0.5rem; }
            .mb-8 { margin-bottom: 1rem; }
            .mb-6 { margin-bottom: 0.75rem; }
            .space-y-6 > * + * { margin-top: 0.75rem; }
            .h-64 { height: 12rem; }
            .min-h-screen { min-height: 600px; }
        }
        
        /* Touch-friendly buttons */
        .touch-button {
            min-height: 48px;
            min-width: 48px;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="h-full antialiased text-slate-200">
    <div id="app" class="h-full w-full max-w-4xl mx-auto flex flex-col">

        <!-- App Header -->
        <header class="flex items-center justify-between p-4 bg-slate-900/80 backdrop-blur-sm border-b border-slate-700/50 sticky top-0 z-10">
            <div id="header-left" class="flex items-center gap-4">
                <button id="back-button" class="hidden p-2 rounded-full hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </button>
                <h1 id="header-title" class="text-xl font-bold text-white">Sessions</h1>
            </div>
            <div id="header-right" class="flex items-center gap-4">
                <button id="controls-nav-btn" onclick="showControlsView()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-xl">
                    Controls
                </button>
                <button id="sessions-nav-btn" onclick="window.location.href='/'" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl">
                    Sessions
                </button>
                <button id="dashboard-nav-btn" onclick="window.location.href='/dashboard'" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-lg text-xl">
                    Dashboard
                </button>
                <div id="status-indicator" class="w-6 h-6 text-green-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg>
                </div>
                <!-- Recording Timer for Header (clickable to stop) -->
                <div id="header-recording-timer" class="hidden bg-red-600 hover:bg-red-700 text-white font-mono font-bold py-2 px-4 rounded-lg text-sm cursor-pointer transition-colors" onclick="stopRecordingFromHeader()" title="Click to stop recording">
                    REC: <span id="header-timer-display">00:00:00</span>
                    <svg class="inline-block w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18,18H6V6H18V18Z"/>
                    </svg>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 relative touch-scrollable">
            
            <!-- View: Session List -->
            <div id="session-list-view">
                <div id="session-list" class="space-y-4">
                    <div class="text-center py-8">
                        <p class="text-slate-400">Loading sessions...</p>
                    </div>
                </div>
            </div>

            <!-- View: Controls (Recording & Playback) -->
            <div id="live-recording-view" class="hidden h-full flex flex-col">
                <div class="max-w-4xl mx-auto w-full flex flex-col h-full p-4">
                    <!-- Now Playing/Recording Section -->
                    <div class="bg-slate-800/50 backdrop-blur rounded-3xl p-6 mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-20 h-20 bg-slate-700 rounded-xl flex items-center justify-center">
                                <div id="recording-icon" class="hidden">
                                    <div class="w-16 h-16 bg-red-500 rounded-full animate-pulse flex items-center justify-center">
                                        <div class="w-8 h-8 bg-red-700 rounded-full"></div>
                                    </div>
                                </div>
                                <svg id="microphone-icon" class="w-10 h-10 text-slate-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2A3 3 0 0 0 9 5V11A3 3 0 0 0 12 14A3 3 0 0 0 15 11V5A3 3 0 0 0 12 2M19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H7A5 5 0 0 0 12 16A5 5 0 0 0 17 11H19Z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 id="control-title" class="text-xl font-semibold text-white">Ready to Record</h3>
                                <p id="control-status" class="text-sm text-slate-400">Tap the microphone to start</p>
                                <p id="recording-timer" class="text-2xl font-mono text-red-400 mt-1 hidden">00:00:00</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Audio Controls -->
                    <div class="bg-slate-800/50 backdrop-blur rounded-3xl p-6 mb-4 flex-1 flex flex-col justify-center">
                        <!-- Waveform Visualization (shown during recording) -->
                        <div id="waveform-container" class="flex items-center justify-center space-x-1 h-24 mb-6">
                            <!-- Waveform bars will be added dynamically -->
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex items-center justify-center space-x-6">
                            <!-- Main Control Button -->
                            <button id="main-control-btn" onclick="toggleRecording()" class="p-6 bg-red-600 rounded-full hover:bg-red-700 transition-all transform hover:scale-105 active:scale-95">
                                <svg id="mic-icon" class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2A3 3 0 0 0 9 5V11A3 3 0 0 0 12 14A3 3 0 0 0 15 11V5A3 3 0 0 0 12 2M19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H7A5 5 0 0 0 12 16A5 5 0 0 0 17 11H19Z"/>
                                </svg>
                                <svg id="stop-icon" class="w-12 h-12 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18,18H6V6H18V18Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Recent Sessions (Touch Scrollable) -->
                    <div class="bg-slate-800/50 backdrop-blur rounded-3xl p-4">
                        <h3 class="text-lg font-semibold text-white mb-3">Recent Sessions</h3>
                        <div id="recent-sessions-list" class="space-y-2 max-h-48 overflow-y-auto touch-scrollable">
                            <!-- Recent sessions will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Session Details -->
            <div id="session-detail-view" class="hidden">
                <div class="space-y-6">
                    <!-- Playback Controls -->
                    <div class="bg-slate-800 p-4 rounded-xl space-y-3">
                        <div class="flex items-center gap-4">
                            <button id="play-button" class="p-3 bg-violet-600 hover:bg-violet-700 rounded-full text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            </button>
                            <div class="flex-1">
                                <div class="w-full h-2 bg-slate-700 rounded-full">
                                    <div id="playback-progress" class="w-0 h-full bg-violet-500 rounded-full transition-all duration-300"></div>
                                </div>
                            </div>
                            <span id="playback-time" class="text-sm font-mono text-slate-400">00:00 / 00:00</span>
                        </div>
                        <audio id="audio-player" class="hidden"></audio>
                    </div>

                    <!-- Participants -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Participants</h2>
                        <div id="detail-participants" class="flex flex-wrap gap-2">
                            <!-- Participants will be injected here -->
                        </div>
                    </div>

                    <!-- AI Summary -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Summary</h2>
                        <p id="detail-summary" class="bg-slate-800 p-4 rounded-xl text-slate-300 leading-relaxed"></p>
                    </div>

                    <!-- Action Items -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Action Items</h2>
                        <ul id="detail-action-items" class="bg-slate-800 p-4 rounded-xl space-y-3 list-none">
                            <!-- Action items will be injected here -->
                        </ul>
                    </div>
                    
                    <!-- Key Moments -->
                    <div>
                        <h2 class="text-lg font-semibold text-white mb-2">Key Moments</h2>
                        <div id="detail-key-moments" class="bg-slate-800 p-4 rounded-xl space-y-3">
                           <!-- Key moments will be injected here -->
                        </div>
                    </div>

                    <!-- Full Transcript -->
                    <div>
                        <button id="toggle-transcript-button" class="w-full text-left font-semibold text-white p-4 bg-slate-800 rounded-xl hover:bg-slate-700 transition-colors flex justify-between items-center">
                            <span>Full Transcript</span>
                            <svg id="transcript-chevron" class="w-5 h-5 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="detail-transcript-container" class="hidden mt-2 bg-slate-800 p-4 rounded-xl max-h-96 overflow-y-auto">
                            <div id="detail-transcript" class="space-y-4 text-slate-300">
                                <!-- Transcript will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Action Button -->
        <div id="fab-container" class="absolute bottom-6 right-6 z-20">
            <div class="relative">
                <div id="fab-pulse-ring" class="absolute inset-0 bg-red-600 rounded-full pulse-ring hidden"></div>
                <button id="record-button" class="touch-button bg-violet-600 hover:bg-violet-700 active:bg-violet-800 text-white p-6 rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all duration-200 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages" class="fixed bottom-4 left-4 z-30 space-y-2">
            <!-- Status messages will be injected here -->
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Global state
        let sessions = [];
        let currentSession = null;
        let isRecording = false;
        let audioPlayer = null;
        let recordingInterval = null;
        
        // Navigation function
        function showControlsView() {
            showView('controls');
            updateControlsView();
            loadRecentSessions();
        }
        
        // Update navigation buttons based on current view
        function updateNavigation(currentView) {
            const sessionsBtn = document.getElementById('sessions-nav-btn');
            const controlsBtn = document.getElementById('controls-nav-btn');
            const dashboardBtn = document.getElementById('dashboard-nav-btn');
            
            // Reset all buttons to inactive state
            const controlsInactiveClass = 'bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-lg text-xl';
            const controlsActiveClass = 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-xl';
            const sessionsInactiveClass = 'bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-lg text-xl';
            const sessionsActiveClass = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl';
            const dashboardClass = 'bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-6 rounded-lg text-xl';
            
            controlsBtn.className = controlsInactiveClass;
            sessionsBtn.className = sessionsInactiveClass;
            dashboardBtn.className = dashboardClass;
            
            // Highlight current view
            if (currentView === 'list') {
                sessionsBtn.className = sessionsActiveClass;
            } else if (currentView === 'controls') {
                controlsBtn.className = controlsActiveClass;
            }
        }
        
        // Update recording visuals
        function updateRecordingVisuals() {
            const recordButton = document.getElementById('record-button');
            const fabPulseRing = document.getElementById('fab-pulse-ring');
            const headerTimer = document.getElementById('header-recording-timer');
            
            if (isRecording) {
                recordButton.classList.remove('bg-violet-600', 'hover:bg-violet-700');
                recordButton.classList.add('bg-red-600', 'hover:bg-red-700');
                fabPulseRing.classList.remove('hidden');
                headerTimer.classList.remove('hidden');
            } else {
                recordButton.classList.add('bg-violet-600', 'hover:bg-violet-700');
                recordButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                fabPulseRing.classList.add('hidden');
                headerTimer.classList.add('hidden');
            }
        }

        // DOM elements
        const views = {
            list: document.getElementById('session-list-view'),
            controls: document.getElementById('live-recording-view'), // Now the controls view
            detail: document.getElementById('session-detail-view')
        };
        
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');
        const recordButton = document.getElementById('record-button');
        const fabContainer = document.getElementById('fab-container');
        const sessionListContainer = document.getElementById('session-list');
        const toggleTranscriptButton = document.getElementById('toggle-transcript-button');
        const transcriptContainer = document.getElementById('detail-transcript-container');
        const transcriptChevron = document.getElementById('transcript-chevron');
        const statusIndicator = document.getElementById('status-indicator');
        const statusMessages = document.getElementById('status-messages');
        const audioPlayerElement = document.getElementById('audio-player');
        const playButton = document.getElementById('play-button');
        const playbackProgress = document.getElementById('playback-progress');
        const playbackTime = document.getElementById('playback-time');

        // Utility functions
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return h > 0 ? `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `px-4 py-2 rounded-lg text-white font-medium ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600'} transform transition-all duration-300 translate-y-full opacity-0`;
            messageEl.textContent = message;
            statusMessages.appendChild(messageEl);
            
            // Animate in
            setTimeout(() => {
                messageEl.classList.remove('translate-y-full', 'opacity-0');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                messageEl.classList.add('translate-y-full', 'opacity-0');
                setTimeout(() => messageEl.remove(), 300);
            }, 3000);
        }

        function updateStatusIndicator(connected = true) {
            if (connected) {
                statusIndicator.className = 'w-6 h-6 text-green-400';
            } else {
                statusIndicator.className = 'w-6 h-6 text-red-400';
            }
        }

        // View management
        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
            
            backButton.classList.toggle('hidden', viewName === 'list');
            fabContainer.classList.toggle('hidden', viewName !== 'list');
            headerTitle.textContent = viewName === 'list' ? 'Sessions' : '';
            
            // Update navigation buttons
            updateNavigation(viewName);
        }

        // Session management
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    sessions = await response.json();
                    renderSessionList();
                } else {
                    showMessage('Failed to load sessions', 'error');
                }
            } catch (error) {
                showMessage('Error loading sessions', 'error');
                console.error('Error loading sessions:', error);
            }
        }

        function renderSessionList() {
            sessionListContainer.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionListContainer.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-slate-400">No sessions found. Press the record button to start your first session.</p>
                    </div>
                `;
                return;
            }

            sessions.sort((a, b) => new Date(b.start_time) - new Date(a.start_time)).forEach(session => {
                const card = document.createElement('div');
                card.className = 'bg-slate-800 p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-700/70 transition-colors duration-200';
                card.dataset.sessionId = session.session_id;

                const date = new Date(session.start_time);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const durationMinutes = Math.floor(session.duration / 60);

                const participantAvatars = session.participants.map(p => 
                    `<div class="w-8 h-8 rounded-full bg-violet-500 flex items-center justify-center text-white font-bold text-sm border-2 border-slate-800 -ml-2">${p.charAt(0)}</div>`
                ).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-white mb-1">${session.title}</h3>
                        <div class="flex items-center -space-x-2">
                            ${participantAvatars}
                        </div>
                    </div>
                    <p class="text-sm text-slate-400 mb-3">${formattedDate} • ${durationMinutes} min</p>
                    <p class="text-slate-300 text-sm truncate">${session.summary}</p>
                `;
                
                card.addEventListener('click', () => renderSessionDetail(session.session_id));
                sessionListContainer.appendChild(card);
            });
        }

        function renderSessionDetail(sessionId) {
            const session = sessions.find(s => s.session_id === sessionId);
            if (!session) return;

            currentSession = session;
            showView('detail');
            headerTitle.textContent = session.title;

            // Populate participants
            document.getElementById('detail-participants').innerHTML = session.participants.map(p => 
                `<span class="bg-slate-700 text-slate-200 px-3 py-1 rounded-full text-sm font-medium">${p}</span>`
            ).join('');

            // Populate summary
            document.getElementById('detail-summary').textContent = session.summary;

            // Populate action items
            const actionItemsList = document.getElementById('detail-action-items');
            actionItemsList.innerHTML = session.action_items.length > 0 ? session.action_items.map(item => `
                <li class="flex items-start gap-3">
                    <div class="w-5 h-5 border-2 border-slate-500 rounded mt-1 flex-shrink-0"></div>
                    <span>${item}</span>
                </li>
            `).join('') : '<li class="text-slate-400">No action items identified.</li>';
            
            // Populate key moments
            const keyMomentsContainer = document.getElementById('detail-key-moments');
            keyMomentsContainer.innerHTML = session.key_moments.length > 0 ? session.key_moments.map(moment => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-700/50 cursor-pointer">
                    <div class="bg-violet-600 text-white text-xs font-mono px-2 py-1 rounded">${moment.timestamp}</div>
                    <div class="text-slate-300">${moment.description}</div>
                </div>
            `).join('') : '<p class="text-slate-400">No key moments identified.</p>';

            // Populate transcript
            const transcriptList = document.getElementById('detail-transcript');
            transcriptList.innerHTML = session.transcript.map(entry => `
                <div>
                    <p class="font-semibold text-violet-400 mb-1">${entry.speaker} <span class="text-xs text-slate-500 font-mono">${entry.timestamp}</span></p>
                    <p class="pl-2">${entry.text}</p>
                </div>
            `).join('');
            
            // Reset transcript visibility
            transcriptContainer.classList.add('hidden');
            transcriptChevron.classList.remove('rotate-180');

            // Set up audio player
            if (session.wav_file) {
                audioPlayerElement.src = `/api/play/${session.session_id}`;
                setupAudioPlayer();
            }
        }

        function setupAudioPlayer() {
            audioPlayerElement.addEventListener('loadedmetadata', () => {
                const duration = audioPlayerElement.duration;
                playbackTime.textContent = `00:00 / ${formatTime(duration)}`;
            });

            audioPlayerElement.addEventListener('timeupdate', () => {
                const currentTime = audioPlayerElement.currentTime;
                const duration = audioPlayerElement.duration;
                const progress = (currentTime / duration) * 100;
                playbackProgress.style.width = `${progress}%`;
                playbackTime.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            });

            audioPlayerElement.addEventListener('ended', () => {
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
                playbackProgress.style.width = '0%';
            });
        }

        // Recording management (now handled by controls view)

        async function startRecording() {
            try {
                const response = await fetch('/api/recording/start', { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    isRecording = true;
                    updateRecordingVisuals();
                    updateControlsView();
                    showMessage('Recording started', 'success');
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to start recording', 'error');
                }
            } catch (error) {
                showMessage('Error starting recording', 'error');
                console.error('Error starting recording:', error);
            }
        }
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function stopRecording() {
            try {
                const response = await fetch('/api/recording/stop', { method: 'POST' });
                if (response.ok) {
                    isRecording = false;
                    updateRecordingVisuals();
                    updateControlsView();
                    showMessage('Recording stopped. Transcribing...', 'success');
                    loadSessions(); // Refresh session list
                    loadRecentSessions(); // Refresh recent sessions in controls view
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to stop recording', 'error');
                }
            } catch (error) {
                showMessage('Error stopping recording', 'error');
                console.error('Error stopping recording:', error);
            }
        }
        
        // Stop recording from header timer (available on all screens)
        async function stopRecordingFromHeader() {
            try {
                showMessage('Stopping recording...', 'info');
                await stopRecording();
            } catch (error) {
                showMessage('Error stopping recording from header', 'error');
                console.error('Error stopping recording from header:', error);
            }
        }

        // Socket.IO event handlers
        socket.on('connect', () => {
            updateStatusIndicator(true);
            showMessage('Connected to server', 'success');
        });

        socket.on('disconnect', () => {
            updateStatusIndicator(false);
            showMessage('Disconnected from server', 'error');
        });

        socket.on('recording_timer', (data) => {
            if (isRecording) {
                const timerEl = document.getElementById('recording-timer');
                const headerTimerEl = document.getElementById('header-timer-display');
                
                if (timerEl) {
                    timerEl.textContent = formatTime(data.duration);
                }
                if (headerTimerEl) {
                    headerTimerEl.textContent = formatTime(data.duration);
                }
            }
        });

        socket.on('transcription_complete', (data) => {
            showMessage('Transcription complete!', 'success');
            loadSessions(); // Refresh session list
        });

        socket.on('transcription_error', (data) => {
            showMessage('Transcription failed', 'error');
        });
        
        socket.on('recording_started', (data) => {
            isRecording = true;
            updateRecordingVisuals();
            updateControlsView();
        });
        
        socket.on('recording_stopped', (data) => {
            isRecording = false;
            updateRecordingVisuals();
            updateControlsView();
        });

        // Update controls view based on recording state
        function updateControlsView() {
            const recordingIcon = document.getElementById('recording-icon');
            const microphoneIcon = document.getElementById('microphone-icon');
            const controlTitle = document.getElementById('control-title');
            const controlStatus = document.getElementById('control-status');
            const recordingTimer = document.getElementById('recording-timer');
            const mainControlBtn = document.getElementById('main-control-btn');
            const micIcon = document.getElementById('mic-icon');
            const stopIcon = document.getElementById('stop-icon');
            const waveformContainer = document.getElementById('waveform-container');
            
            if (isRecording) {
                // Recording state
                recordingIcon.classList.remove('hidden');
                microphoneIcon.classList.add('hidden');
                controlTitle.textContent = 'Recording Session';
                controlStatus.textContent = 'Tap to stop recording';
                recordingTimer.classList.remove('hidden');
                mainControlBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                mainControlBtn.classList.add('bg-slate-700', 'hover:bg-slate-800');
                micIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                
                // Generate waveform bars
                if (waveformContainer.children.length === 0) {
                    for (let i = 0; i < 40; i++) {
                        const bar = document.createElement('div');
                        bar.className = 'waveform-bar w-1 bg-red-500 rounded-full';
                        bar.style.animationDelay = `${Math.random() * -1.5}s`;
                        bar.style.height = `${20 + Math.random() * 80}%`;
                        waveformContainer.appendChild(bar);
                    }
                }
            } else {
                // Ready state
                recordingIcon.classList.add('hidden');
                microphoneIcon.classList.remove('hidden');
                controlTitle.textContent = 'Ready to Record';
                controlStatus.textContent = 'Tap the microphone to start';
                recordingTimer.classList.add('hidden');
                mainControlBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                mainControlBtn.classList.remove('bg-slate-700', 'hover:bg-slate-800');
                micIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                
                // Clear waveform
                waveformContainer.innerHTML = '';
            }
        }
        
        // Load recent sessions for controls view
        async function loadRecentSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    const allSessions = await response.json();
                    const recentSessions = allSessions
                        .sort((a, b) => new Date(b.start_time) - new Date(a.start_time))
                        .slice(0, 5); // Show only 5 most recent
                    
                    const recentSessionsList = document.getElementById('recent-sessions-list');
                    
                    if (recentSessions.length === 0) {
                        recentSessionsList.innerHTML = '<p class="text-slate-400 text-sm">No recent sessions</p>';
                        return;
                    }
                    
                    recentSessionsList.innerHTML = recentSessions.map(session => {
                        const date = new Date(session.start_time);
                        const timeAgo = getTimeAgo(date);
                        const duration = Math.floor(session.duration / 60);
                        
                        return `
                            <div class="bg-slate-700/50 p-3 rounded-xl cursor-pointer hover:bg-slate-700 transition-colors" 
                                 onclick="renderSessionDetail('${session.session_id}')">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <h4 class="text-white font-medium text-sm truncate">${session.title}</h4>
                                        <p class="text-slate-400 text-xs">${timeAgo} • ${duration} min</p>
                                    </div>
                                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading recent sessions:', error);
            }
        }
        
        // Helper function to get relative time
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            
            return "Just now";
        }

        // Event listeners
        backButton.addEventListener('click', () => showView('list'));
        recordButton.addEventListener('click', () => {
            // Navigate to controls view when blue mic button is pressed
            showControlsView();
        });
        
        playButton.addEventListener('click', () => {
            if (audioPlayerElement.paused) {
                audioPlayerElement.play();
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
            } else {
                audioPlayerElement.pause();
                playButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
            }
        });
        
        toggleTranscriptButton.addEventListener('click', () => {
            transcriptContainer.classList.toggle('hidden');
            transcriptChevron.classList.toggle('rotate-180');
        });

        // Initialize the app
        loadSessions();
        loadRecentSessions();
        
        // Check URL parameters for direct navigation
        const urlParams = new URLSearchParams(window.location.search);
        const viewParam = urlParams.get('view');
        
        if (viewParam === 'controls') {
            showControlsView();
        } else {
            showView('list');
        }
    </script>
</body>
</html>